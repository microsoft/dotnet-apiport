<?xml version="1.0" encoding="UTF-8"?>
<ApplicationManifest 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
    xmlns="http://schemas.microsoft.com/2011/01/fabric" ApplicationTypeName="PortabilityServiceType" ApplicationTypeVersion="v1">
    <Parameters>
        <Parameter Name="RepositoryUserName" DefaultValue="portabilityservice" />
        <Parameter Name="RepositoryPassword" DefaultValue="RepositoryPasswordHere" />
        <Parameter Name="EnvironmentName" DefaultValue="Production" />
    </Parameters>
    <ServiceManifestImport>
        <ServiceManifestRef ServiceManifestName="portabilityservice.configurationservicePkg" ServiceManifestVersion="v1"/>
        <EnvironmentOverrides CodePackageRef="portabilityservice.configurationservice.Code">
            <EnvironmentVariable Name="ASPNETCORE_ENVIRONMENT" Value="[EnvironmentName]"/>
        </EnvironmentOverrides>
        <Policies>
            <ContainerHostPolicies CodePackageRef="portabilityservice.configurationservice.Code">
                <RepositoryCredentials AccountName="[RepositoryUserName]" Password="[RepositoryPassword]"/>
                <ImageOverrides>
                    <!-- The image tag isn't parameterized because Service Fabric currently doesn't support parameters in the
                    image name. -->
                    <Image Name="portabilityservice.azurecr.io/portabilityservice-configurationservice:0.5" />
                </ImageOverrides>                
                <PortBinding ContainerPort="80" EndpointRef="portabilityservice.configurationserviceEndpoint"/>
            </ContainerHostPolicies>
            <ServicePackageResourceGovernancePolicy/>
        </Policies>
    </ServiceManifestImport>
    <ServiceManifestImport>
        <ServiceManifestRef ServiceManifestName="portabilityservice.gatewayPkg" ServiceManifestVersion="v1"/>
        <EnvironmentOverrides CodePackageRef="portabilityservice.gateway.Code">
            <EnvironmentVariable Name="PortabilityConfigurationServiceUrl" Value="http://portabilityservice.configurationservice:8001"/>
            <EnvironmentVariable Name="ASPNETCORE_ENVIRONMENT" Value="[EnvironmentName]"/>
        </EnvironmentOverrides>
        <Policies>
            <ContainerHostPolicies CodePackageRef="portabilityservice.gateway.Code">
                <RepositoryCredentials AccountName="[RepositoryUserName]" Password="[RepositoryPassword]"/>
                <ImageOverrides>
                    <!-- The image tag isn't parameterized because Service Fabric currently doesn't support parameters in the
                    image name. -->                
                    <Image Name="portabilityservice.azurecr.io/portabilityservice-gateway:0.5" />
                </ImageOverrides>
                <PortBinding ContainerPort="80" EndpointRef="portabilityservice.gatewayEndpoint"/>
            </ContainerHostPolicies>
            <ServicePackageResourceGovernancePolicy/>
        </Policies>
    </ServiceManifestImport>
    <ServiceManifestImport>
      <ServiceManifestRef ServiceManifestName="portabilityservice.analysisservicePkg" ServiceManifestVersion="v1"/>
      <EnvironmentOverrides CodePackageRef="portabilityservice.analysisservice.Code">
        <EnvironmentVariable Name="PortabilityConfigurationServiceUrl" Value="http://portabilityservice.configurationservice:8001"/>
        <EnvironmentVariable Name="ASPNETCORE_ENVIRONMENT" Value="[EnvironmentName]"/>
      </EnvironmentOverrides>
      <Policies>
        <ContainerHostPolicies CodePackageRef="portabilityservice.analysisservice.Code">
          <RepositoryCredentials AccountName="[RepositoryUserName]" Password="[RepositoryPassword]"/>
          <ImageOverrides>
            <!-- The image tag isn't parameterized because Service Fabric currently doesn't support parameters in the
            image name. -->
            <Image Name="portabilityservice.azurecr.io/portabilityservice-analysisservice:0.5" />
          </ImageOverrides>
          <PortBinding ContainerPort="80" EndpointRef="portabilityservice.analysisserviceEndpoint"/>
        </ContainerHostPolicies>
        <ServicePackageResourceGovernancePolicy/>
      </Policies>
    </ServiceManifestImport>
    <DefaultServices>
        <Service Name="portabilityservice.configurationservice" ServiceDnsName="portabilityservice.configurationservice" ServicePackageActivationMode="ExclusiveProcess">
            <StatelessService ServiceTypeName="portabilityservice.configurationserviceType">
                <SingletonPartition/>
            </StatelessService>
        </Service>
        <Service Name="portabilityservice.gateway" ServiceDnsName="portabilityservice.gateway" ServicePackageActivationMode="ExclusiveProcess">
            <StatelessService ServiceTypeName="portabilityservice.gatewayType" InstanceCount="-1">
                <SingletonPartition/>
            </StatelessService>
        </Service>
        <Service Name="portabilityservice.analysisservice" ServiceDnsName="portabilityservice.analysisservice" ServicePackageActivationMode="ExclusiveProcess">
          <StatelessService ServiceTypeName="portabilityservice.analysisserviceType">
            <SingletonPartition/>
          </StatelessService>
        </Service>
    </DefaultServices>
</ApplicationManifest>